generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(uuid())
  provider   String // google, discord, steam
  providerId String // external ID
  username   String   @unique
  displayName String
  email      String   @unique
  avatar     String   @default("/assets/avatars/free/default.png")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  isAdmin    Boolean  @default(false)
  termsAcceptedAt DateTime?

  level Int @default(1)
  xp    Int @default(0)
  currency Int @default(0)

  cosmetics Cosmetic[]
  purchasedItems PurchasedItem[]
  loadout   Loadout?

  rank    Rank?
  replays Replay[]

  sessions UserSession[]

  @@unique([provider, providerId])
}

model UserSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
}

model Rank {
  userId         String   @id
  user           User     @relation(fields: [userId], references: [id])
  elo            Int      @default(1000)
  tier           String   @default("BRONZE")
  wins           Int      @default(0)
  losses         Int      @default(0)
  streak         Int      @default(0)
  longestStreak  Int      @default(0)
  season         Int      @default(1)
  updatedAt      DateTime @updatedAt
}

model Cosmetic {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  type       String // "avatar", "badge", "reaction", etc.
  key        String
  unlockedAt DateTime @default(now())

  @@unique([userId, type, key])
}

model PurchasedItem {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // "avatar", "badge", "reaction", etc.
  key       String
  purchasedAt DateTime @default(now())

  @@unique([userId, type, key])
  @@index([userId])
}

model Loadout {
  id        String  @id @default(uuid())
  userId    String  @unique
  user      User    @relation(fields: [userId], references: [id])
  unitSkins Json
  badge     String?
  reaction  String  @default("default")
}

model GameSession {
  id          String   @id @default(uuid())
  player1Id   String
  player2Id   String
  serverUrl   String?
  port        Int?
  status      String   @default("waiting") // waiting, match_found, in_progress, completed, abandoned
  winnerId    String?
  loserId     String?
  endReason   String?  // timeout, noUnits, kingDefeated
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gameStats   GameStats[]
  replays     Replay[]

  @@index([player1Id])
  @@index([player2Id])
  @@index([status])
}

model GameStats {
  id                        String   @id @default(uuid())
  gameSessionId             String
  gameSession               GameSession @relation(fields: [gameSessionId], references: [id])
  userId                    String
  isPlayer1                 Boolean
  unitsKilled               Int      @default(0)
  unitsLost                 Int      @default(0)
  damageDealt               Int      @default(0)
  damageHealed              Int      @default(0)
  rounds                    Int      @default(0)
  duration                  Int      @default(0)
  timeUsed                  Int      @default(0)
  attacksMade               Int      @default(0)
  killsLanded               Int      @default(0)
  avgDamagePerAttack         Float    @default(0)
  remainingKingHealth       Int      @default(0)
  
  // Damage by unit type
  meleeDamage               Int      @default(0)
  rangedDamage              Int      @default(0)
  mageDamage                Int      @default(0)
  healerDamage              Int      @default(0)
  cavalryDamage            Int      @default(0)
  scoutDamage               Int      @default(0)
  tankDamage                Int      @default(0)
  kingDamage                Int      @default(0)
  
  // Healing by unit type
  meleeHealing             Int      @default(0)
  rangedHealing            Int      @default(0)
  mageHealing              Int      @default(0)
  healerHealing            Int      @default(0)
  cavalryHealing           Int      @default(0)
  scoutHealing              Int      @default(0)
  tankHealing               Int      @default(0)
  kingHealing               Int      @default(0)
  
  // Units killed by type
  meleeKilled               Int      @default(0)
  rangedKilled              Int      @default(0)
  mageKilled                Int      @default(0)
  healerKilled              Int      @default(0)
  cavalryKilled            Int      @default(0)
  scoutKilled               Int      @default(0)
  tankKilled                Int      @default(0)
  kingKilled                Int      @default(0)
  
  // Units lost by type
  meleeLost                 Int      @default(0)
  rangedLost                Int      @default(0)
  mageLost                  Int      @default(0)
  healerLost                Int      @default(0)
  cavalryLost               Int      @default(0)
  scoutLost                 Int      @default(0)
  tankLost                  Int      @default(0)
  kingLost                  Int      @default(0)

  @@index([userId])
}

model Replay {
  id            String   @id @default(uuid())
  gameSessionId String
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id])
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  matchData     Json
  winnerId      String
  duration      Int
  createdAt     DateTime @default(now())

  @@unique([gameSessionId, userId])
  @@index([userId])
  @@index([createdAt])
}

model PatchNote {
  id        String   @id @default(uuid())
  version   String
  title     String
  content   String
  imageUrl  String?
  createdAt DateTime @default(now())

  @@index([createdAt])
}
